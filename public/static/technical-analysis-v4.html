<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼ v3.0 INDENT FIXED 055945 - Alpha Vantage</title>
  <script src="https://cdn.tailwindcss.com?v=20250204f"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js?v=20250204c"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3B82F6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .score-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 9999px;
      font-weight: bold;
      font-size: 0.875rem;
    }
    .score-strong-buy { background-color: #10b981; color: white; }
    .score-buy { background-color: #3b82f6; color: white; }
    .score-neutral { background-color: #6b7280; color: white; }
    .score-sell { background-color: #ef4444; color: white; }
    .score-strong-sell { background-color: #7f1d1d; color: white; }
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .nav-bar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1rem 2rem;
      margin-bottom: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .nav-links {
      display: flex;
      gap: 2rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .nav-link {
      color: white;
      text-decoration: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    .nav-link.active {
      background-color: rgba(147, 112, 219, 0.8);
      border-bottom: 3px solid white;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
  <nav class="nav-bar">
    <div class="nav-links">
      <a href="/static/technical-analysis-v4.html" class="nav-link active">
        <i class="fas fa-chart-bar"></i>
        ğŸ“Š ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼
      </a>
      <a href="/static/nasdaq-ranking.html" class="nav-link">
        <i class="fas fa-trophy"></i>
        ğŸ† NASDAQ-100ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      </a>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-lg shadow-lg mb-8">
      <h1 class="text-4xl font-bold mb-2">
        <i class="fas fa-chart-bar mr-3"></i>
        ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚¹ã‚¯ãƒªãƒ¼ãƒŠãƒ¼
      </h1>
      <p class="text-xl opacity-90">Alpha Vantage 50+ æŒ‡æ¨™ã«ã‚ˆã‚‹é«˜åº¦ãªãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ</p>
      <p class="mt-2 text-sm opacity-75">
        ã‚·ã‚¹ãƒ†ãƒ Aï¼ˆã‚·ãƒ³ãƒ—ãƒ«5æŒ‡æ¨™ï¼‰ â€¢ ã‚·ã‚¹ãƒ†ãƒ Bï¼ˆé«˜åº¦ãªè¤‡åˆè©•ä¾¡20+æŒ‡æ¨™ï¼‰ â€¢ ã‚·ã‚¹ãƒ†ãƒ Cï¼ˆMLäºˆæ¸¬125ç‰¹å¾´é‡ï¼‰
      </p>
    </div>

    <!-- éŠ˜æŸ„å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">
        <i class="fas fa-search mr-2 text-indigo-600"></i>
        éŠ˜æŸ„åˆ†æ
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-semibold mb-2">éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰</label>
          <input 
            type="text" 
            id="symbol-input" 
            placeholder="ä¾‹: AAPL, TSLA, MSFT" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold mb-2">Alpha Vantage API Key</label>
          <input 
            type="text" 
            id="api-key-input" 
            placeholder="Your Alpha Vantage API Key" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>
      </div>
      
      <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-3">
          <input 
            type="checkbox" 
            id="enable-ml-checkbox" 
            class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
            checked
          />
          <div class="flex-1">
            <label for="enable-ml-checkbox" class="font-semibold text-gray-800 cursor-pointer">
              <i class="fas fa-robot text-purple-600"></i>
              ã‚·ã‚¹ãƒ†ãƒ Cï¼ˆMLäºˆæ¸¬ï¼‰ã‚’æœ‰åŠ¹åŒ–
            </label>
            <p class="text-sm text-gray-600 mt-1">
              LightGBMãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹125ç‰¹å¾´é‡åˆ†æã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆå‡¦ç†æ™‚é–“: ç´„15-30ç§’ï¼‰
            </p>
          </div>
        </div>
      </div>
      
      <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-3">
          <input 
            type="checkbox" 
            id="enable-backfit-checkbox" 
            class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <div class="flex-1">
            <label for="enable-backfit-checkbox" class="font-semibold text-gray-800 cursor-pointer">
              <i class="fas fa-chart-line text-blue-600"></i>
              ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼ã‚’å®Ÿæ–½
            </label>
            <p class="text-sm text-gray-600 mt-1">
              éå»30æ—¥ã‚’é™¤å¤–ã—ãŸåˆ¥ãƒ¢ãƒ‡ãƒ«ã§å­¦ç¿’ã—ã€äºˆæ¸¬ç²¾åº¦ã‚’æ¤œè¨¼ã—ã¾ã™ï¼ˆè¿½åŠ æ™‚é–“: ç´„5-10ç§’ï¼‰
            </p>
          </div>
        </div>
      </div>
      
      <button 
        onclick="analyzeTechnical()" 
        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-4 rounded-lg font-semibold transition text-lg"
      >
        <i class="fas fa-chart-bar mr-2"></i>ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚’é–‹å§‹
      </button>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading" style="display:none;" class="bg-white rounded-lg shadow-md p-8 mb-6">
      <div class="loader"></div>
      <p id="loading-message" class="text-center text-gray-600 text-lg">åˆ†æä¸­...</p>
      <p class="text-center text-gray-500 text-sm mt-2">
        Alpha Vantageã‹ã‚‰50+ã®ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‚’å–å¾—ä¸­ï¼ˆç´„20-30ç§’ï¼‰
      </p>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="results" style="display:none;">
      <!-- ã‚·ã‚¹ãƒ†ãƒ Açµæœ -->
      <div id="system-a-results" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <!-- å‹•çš„ã«æŒ¿å…¥ -->
      </div>
      
      <!-- ã‚·ã‚¹ãƒ†ãƒ Bçµæœ -->
      <div id="system-b-results" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <!-- å‹•çš„ã«æŒ¿å…¥ -->
      </div>
      
      <!-- ã‚·ã‚¹ãƒ†ãƒ Cçµæœ -->
      <div id="system-c-results" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <!-- å‹•çš„ã«æŒ¿å…¥ -->
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="error-display" style="display:none;" class="bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
      <div class="flex items-start">
        <i class="fas fa-exclamation-circle text-red-500 text-3xl mr-4"></i>
        <div>
          <h3 class="text-xl font-bold text-red-800 mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
          <p id="error-message" class="text-red-700"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ãƒ—ãƒ­ã‚­ã‚·APIã‚’ä½¿ç”¨ï¼ˆCORSå›é¿ï¼‰
    const USE_PROXY = true  // ãƒ—ãƒ­ã‚­ã‚·ã‚’æœ‰åŠ¹åŒ–

    async function analyzeTechnical() {
      const symbol = document.getElementById('symbol-input').value.trim().toUpperCase()
      const apiKey = document.getElementById('api-key-input').value.trim()
      const enableML = document.getElementById('enable-ml-checkbox').checked
      const enableBackfit = document.getElementById('enable-backfit-checkbox').checked
      
      if (!symbol) {
        alert('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        return
      }
      
      if (!apiKey) {
        alert('Alpha Vantage API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
        return
      }
      
      // UIãƒªã‚»ãƒƒãƒˆ
      document.getElementById('results').style.display = 'none'
      document.getElementById('error-display').style.display = 'none'
      document.getElementById('loading').style.display = 'block'
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
      let loadingMsg = 'ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‚’å–å¾—ä¸­...'
      if (enableML && enableBackfit) {
        loadingMsg += ' + MLå­¦ç¿’ + ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼'
      } else if (enableML) {
        loadingMsg += ' + MLå­¦ç¿’'
      }
      document.getElementById('loading-message').textContent = loadingMsg
      
      try {
        // ãƒ—ãƒ­ã‚­ã‚·APIçµŒç”±ã§ã‚·ã‚¹ãƒ†ãƒ A & B ã®åˆ†æ
        console.log('[CALL] /api/proxy/technical-analysis')
        const technicalResponse = await axios.post('/api/proxy/technical-analysis', {
          symbol: symbol,
          alpha_vantage_api_key: apiKey,
          mode: 'both',
          timeframe: 'medium'  // "short" or "medium"
        })
        
        console.log('[RESPONSE] Technical analysis:', technicalResponse.data)
        
        // çµæœã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼‰
        if (technicalResponse.data.system_a) {
          displaySystemA(technicalResponse.data.system_a)
        } else {
          console.error('[ERROR] system_a is missing in response')
          document.getElementById('system-a-results').innerHTML = `
            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6">
              <p class="text-red-700">ã‚·ã‚¹ãƒ†ãƒ Aã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>
            </div>
          `
        }
        
        if (technicalResponse.data.system_b) {
          displaySystemB(technicalResponse.data.system_b)
        } else {
          console.error('[ERROR] system_b is missing in response')
          document.getElementById('system-b-results').innerHTML = `
            <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6">
              <p class="text-red-700">ã‚·ã‚¹ãƒ†ãƒ Bã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</p>
            </div>
          `
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ Cï¼ˆMLäºˆæ¸¬ï¼‰
        if (enableML) {
          console.log('[CALL] /api/proxy/technical-ml-predict')
          const mlResponse = await axios.post('/api/proxy/technical-ml-predict', {
            symbol: symbol,
            alpha_vantage_api_key: apiKey,
            enable_backfit: enableBackfit,
            force_retrain: false
          })
          
          console.log('[RESPONSE] ML prediction:', mlResponse.data)
          displaySystemC(mlResponse.data)
        } else {
          document.getElementById('system-c-results').innerHTML = `
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-robot text-6xl mb-4"></i>
              <p class="text-lg">ã‚·ã‚¹ãƒ†ãƒ Cï¼ˆMLäºˆæ¸¬ï¼‰ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™</p>
              <p class="text-sm mt-2">ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹ã«ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
            </div>
          `
        }
        
        document.getElementById('loading').style.display = 'none'
        document.getElementById('results').style.display = 'block'
        
      } catch (error) {
        console.error('[ERROR]', error)
        document.getElementById('loading').style.display = 'none'
        document.getElementById('error-display').style.display = 'block'
        document.getElementById('error-message').textContent = error.response?.data?.detail || error.message
      }
    }
    
    function displaySystemA(data) {
      if (!data) {
        document.getElementById('system-a-results').innerHTML = '<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      const signalClass = {
        'STRONG_BUY': 'score-strong-buy',
        'BUY': 'score-buy',
        'NEUTRAL': 'score-neutral',
        'SELL': 'score-sell',
        'STRONG_SELL': 'score-strong-sell',
        'å¼·ã„è²·ã„': 'score-strong-buy',
        'è²·ã„': 'score-buy',
        'ä¸­ç«‹': 'score-neutral',
        'å£²ã‚Š': 'score-sell',
        'å¼·ã„å£²ã‚Š': 'score-strong-sell'
      }[data.signal_type] || 'score-neutral';
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ã‚³ã‚¢ã®HTMLç”Ÿæˆï¼ˆå®‰å…¨ã«ï¼‰
      let categoryScoresHtml = '';
      try {
        const categoryNames = {
          'golden_cross': 'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹',
          'rsi': 'RSI',
          'macd': 'MACD',
          'bollinger': 'ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰',
          'volume': 'å‡ºæ¥é«˜'
        };
        
        if (data.category_scores && typeof data.category_scores === 'object') {
          const entries = Object.entries(data.category_scores);
          if (entries && entries.length > 0) {
            categoryScoresHtml = entries.map(([key, score]) => {
              const scorePercent = score || 0;
              const signalColor = scorePercent >= 70 ? 'green' : scorePercent >= 50 ? 'blue' : scorePercent >= 30 ? 'yellow' : 'red';
              const categoryName = categoryNames[key] || key;
              
              return `
              <div class="border-l-4 border-${signalColor}-500 bg-${signalColor}-50 p-4 rounded">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-bold text-gray-800">${categoryName}</span>
                  <span class="text-sm text-${signalColor}-600 font-bold">
                    ${scorePercent}ç‚¹
                  </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-${signalColor}-500 h-2 rounded-full" style="width: ${scorePercent}%"></div>
                </div>
              </div>
              `;
            }).join('');
          } else {
            categoryScoresHtml = '<p class="text-gray-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ã‚³ã‚¢ãŒç©ºã§ã™</p>';
          }
        } else {
          categoryScoresHtml = '<p class="text-gray-500">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ã‚³ã‚¢ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</p>';
        }
      } catch (e) {
        console.error('Error rendering category scores:', e);
        categoryScoresHtml = '<p class="text-red-500">ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼</p>';
      }
      
      const html = `
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg mb-6">
          <h2 class="text-3xl font-bold mb-4 text-indigo-800">
            <i class="fas fa-star mr-2"></i>ã‚·ã‚¹ãƒ†ãƒ A: ã‚·ãƒ³ãƒ—ãƒ«è©•ä¾¡ï¼ˆ5æŒ‡æ¨™ï¼‰
          </h2>
          <p class="text-gray-700 mb-4">åˆå¿ƒè€…å‘ã‘ã®åŸºæœ¬çš„ãªãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã®ã¿ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ³ãƒ—ãƒ«ãªè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ </p>
          
          <div class="grid grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ç·åˆã‚¹ã‚³ã‚¢</p>
              <p class="text-5xl font-bold text-indigo-600">${data.total_score || 0}</p>
              <p class="text-gray-500 mt-2">/100ç‚¹</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ã‚·ã‚°ãƒŠãƒ«</p>
              <p class="text-3xl font-bold">
                <span class="score-badge ${signalClass}">${data.signal_type || 'ä¸æ˜'}</span>
              </p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ä¿¡é ¼åº¦</p>
              <p class="text-5xl font-bold text-green-600">${data.confidence || 0}</p>
              <p class="text-gray-500 mt-2">%</p>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4 text-gray-800">
              <i class="fas fa-chart-bar mr-2"></i>ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã‚¹ã‚³ã‚¢
            </h3>
            <div class="space-y-3">
              ${categoryScoresHtml}
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('system-a-results').innerHTML = html;
    }
    
    function displaySystemB(data) {
      if (!data) {
        document.getElementById('system-b-results').innerHTML = '<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      const signalClass = {
        'STRONG_BUY': 'score-strong-buy',
        'BUY': 'score-buy',
        'NEUTRAL': 'score-neutral',
        'SELL': 'score-sell',
        'STRONG_SELL': 'score-strong-sell',
        'å¼·ã„è²·ã„': 'score-strong-buy',
        'è²·ã„': 'score-buy',
        'ä¸­ç«‹': 'score-neutral',
        'å£²ã‚Š': 'score-sell',
        'å¼·ã„å£²ã‚Š': 'score-strong-sell'
      }[data.signal_type] || 'score-neutral';
      
      const html = `
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg mb-6">
          <h2 class="text-3xl font-bold mb-4 text-purple-800">
            <i class="fas fa-brain mr-2"></i>ã‚·ã‚¹ãƒ†ãƒ B: é«˜åº¦ãªè¤‡åˆè©•ä¾¡ï¼ˆ20+æŒ‡æ¨™ï¼‰
          </h2>
          <p class="text-gray-700 mb-4">ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ã‚¸ãƒ¼ãƒ æ¤œå‡º â€¢ å‹•çš„é‡ã¿ä»˜ã‘ â€¢ ç›¸é–¢èª¿æ•´ â€¢ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒœãƒ¼ãƒŠã‚¹ â€¢ ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢</p>
          
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ç·åˆã‚¹ã‚³ã‚¢</p>
              <p class="text-4xl font-bold text-purple-600">${data.total_score}</p>
              <p class="text-gray-500 mt-1">/100ç‚¹</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ã‚·ã‚°ãƒŠãƒ«</p>
              <p class="text-2xl font-bold">
                <span class="score-badge ${signalClass}">${data.signal_type}</span>
              </p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ä¿¡é ¼åº¦</p>
              <p class="text-4xl font-bold text-green-600">${data.confidence}</p>
              <p class="text-gray-500 mt-1">%</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ã‚¸ãƒ¼ãƒ </p>
              <p class="text-lg font-bold text-indigo-600">${data.market_regime}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ -->
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="font-bold text-lg mb-4 text-gray-800">
                <i class="fas fa-layer-group mr-2"></i>ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢
              </h3>
              <div class="space-y-3" id="system-b-category-scores">
              </div>
            </div>
            
            <!-- ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ -->
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="font-bold text-lg mb-4 text-gray-800">
                <i class="fas fa-shield-alt mr-2"></i>ãƒªã‚¹ã‚¯è©•ä¾¡
              </h3>
              <div class="text-center mb-4">
                <p class="text-5xl font-bold ${data.risk_score < 30 ? 'text-green-600' : data.risk_score < 70 ? 'text-yellow-600' : 'text-red-600'}">
                  ${data.risk_score}
                </p>
                <p class="text-gray-500 mt-2">ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ï¼ˆä½ã„ã»ã©å®‰å…¨ï¼‰</p>
              </div>
              <div class="bg-gray-50 p-3 rounded">
                <p class="text-xs text-gray-600 text-center">
                  ${data.risk_score < 30 ? 'âœ“ ä½ãƒªã‚¹ã‚¯' : data.risk_score < 70 ? 'â–³ ä¸­ãƒªã‚¹ã‚¯' : 'âœ— é«˜ãƒªã‚¹ã‚¯'}
                </p>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ã‚³ã‚¢ã‚µãƒãƒªãƒ¼ -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4 text-gray-800">
              <i class="fas fa-info-circle mr-2"></i>è©•ä¾¡ã‚µãƒãƒªãƒ¼
            </h3>
            <div class="space-y-4">
              <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <p class="font-bold text-gray-800 mb-2">ãƒãƒ¼ã‚±ãƒƒãƒˆç’°å¢ƒ</p>
                <p class="text-sm text-gray-700">${data.market_regime}</p>
              </div>
              
              <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                <p class="font-bold text-gray-800 mb-2">ã‚¹ãƒ†ãƒƒãƒ—2: å¸‚å ´ç’°å¢ƒæ¤œå‡º</p>
                <p class="text-sm text-gray-700">æ¤œå‡ºçµæœ: <span class="font-bold text-indigo-600">${data.calculation_logic.step2_market_regime}</span></p>
              </div>
              
              <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                <p class="font-bold text-gray-800 mb-2">ç·åˆã‚¹ã‚³ã‚¢</p>
                <p class="text-3xl font-bold text-indigo-600">${data.total_score}/100</p>
              </div>
              
              <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                <p class="font-bold text-gray-800 mb-2">ã‚·ã‚°ãƒŠãƒ«</p>
                <p class="text-2xl font-bold text-green-600">${data.signal_type}</p>
              </div>
            </div>
          </div>
        </div>
      `
      
      document.getElementById('system-b-results').innerHTML = html;
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ã‚³ã‚¢ã‚’å®‰å…¨ã«è¿½åŠ 
      try {
        const categoryScoresContainer = document.getElementById('system-b-category-scores');
        if (categoryScoresContainer && data.category_scores && typeof data.category_scores === 'object') {
          const categoryNames = {
            'trend': 'ãƒˆãƒ¬ãƒ³ãƒ‰',
            'momentum': 'ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ ',
            'volatility': 'ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£',
            'volume': 'å‡ºæ¥é«˜'
          };
          
          const entries = Object.entries(data.category_scores);
          if (entries && entries.length > 0) {
            const categoryHtml = entries.map(([category, score]) => {
              const scoreValue = typeof score === 'number' ? score : 0;
              const categoryName = categoryNames[category] || category;
              return `
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-semibold text-gray-700">${categoryName}</span>
                  <span class="text-sm font-bold text-purple-600">${scoreValue.toFixed(1)}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-purple-600 h-2 rounded-full" style="width: ${scoreValue}%"></div>
                </div>
              </div>
              `;
            }).join('');
            
            categoryScoresContainer.innerHTML = categoryHtml;
          } else {
            categoryScoresContainer.innerHTML = '<p class="text-gray-500 text-sm">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¹ã‚³ã‚¢ãŒç©ºã§ã™</p>';
          }
        }
      } catch (e) {
        console.error('Error rendering System B category scores:', e);
      }
    }
    
    function displaySystemC(data) {
      console.log('[displaySystemC] Received data:', data)
      
      if (!data || !data.training || !data.training.metrics) {
        document.getElementById('system-c-results').innerHTML = `
          <div class="bg-gray-100 border-2 border-gray-300 rounded-lg p-6 text-center">
            <i class="fas fa-robot text-gray-400 text-6xl mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">MLäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p class="text-sm text-gray-500">å­¦ç¿’ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
          </div>
        `
        return
      }
      
      const training = data.training.metrics
      const future = data.future_predictions
      const backfit = data.training.backfit_predictions
      const featureImportances = data.training.feature_importances
      // ç¾åœ¨ä¾¡æ ¼ã‚’æ­£ã—ãå–å¾—ï¼ˆfuture_predictions.current_priceã¾ãŸã¯data.current_priceï¼‰
      const current_price = data.current_price || future?.current_price || 0
      
      const html = `
        <div class="bg-gradient-to-r from-green-50 to-teal-50 p-6 rounded-lg mb-6">
          <h2 class="text-3xl font-bold mb-4 text-green-800">
            <i class="fas fa-robot mr-2"></i>ã‚·ã‚¹ãƒ†ãƒ C: MLäºˆæ¸¬ï¼ˆ107ç‰¹å¾´é‡ + LightGBMï¼‰
          </h2>
          <p class="text-gray-700 mb-6">æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹æœªæ¥7æ—¥äºˆæ¸¬ï¼ˆDirect LGBM + Decayï¼‰ + éå»30æ—¥ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼</p>
          
          <!-- MLå­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹èª¬æ˜ -->
          ${data.ml_training_process ? `
          <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
            <h3 class="font-bold text-lg text-blue-800 mb-3">
              <i class="fas fa-info-circle mr-2"></i>MLå­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã®èª¬æ˜
            </h3>
            <p class="text-sm text-gray-700 mb-3">${data.ml_training_process.overview}</p>
            <details class="text-sm">
              <summary class="cursor-pointer font-semibold text-blue-700 hover:text-blue-900 mb-2">
                è©³ç´°ãªå­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º <i class="fas fa-chevron-down ml-1"></i>
              </summary>
              <div class="mt-3 space-y-3">
                ${data.ml_training_process.steps.map(step => `
                  <div class="bg-white p-3 rounded border border-blue-200">
                    <p class="font-bold text-blue-800">ã‚¹ãƒ†ãƒƒãƒ—${step.step}: ${step.name}</p>
                    <p class="text-gray-700 text-xs mt-1">${step.description}</p>
                  </div>
                `).join('')}
              </div>
              <div class="mt-4 bg-white p-3 rounded border border-blue-200">
                <p class="font-bold text-blue-800 mb-2">è©•ä¾¡æŒ‡æ¨™ã®æ„å‘³</p>
                <ul class="text-xs text-gray-700 space-y-1">
                  <li><strong>MAE:</strong> ${data.ml_training_process.metrics_explanation.mae}</li>
                  <li><strong>RMSE:</strong> ${data.ml_training_process.metrics_explanation.rmse}</li>
                  <li><strong>RÂ²:</strong> ${data.ml_training_process.metrics_explanation.r2}</li>
                  <li><strong>MAPE:</strong> ${data.ml_training_process.metrics_explanation.mape}</li>
                </ul>
              </div>
              <div class="mt-3 bg-white p-3 rounded border border-blue-200">
                <p class="font-bold text-blue-800 mb-1">ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼ã«ã¤ã„ã¦</p>
                <p class="text-xs text-gray-700">${data.ml_training_process.backfit_explanation.description}</p>
              </div>
            </details>
          </div>
          ` : ''}
          
          <!-- å­¦ç¿’ã‚µãƒãƒªãƒ¼ -->
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">å­¦ç¿’æ™‚é–“</p>
              <p class="text-3xl font-bold text-green-600">${training.training_duration.toFixed(1)}ç§’</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">RÂ² ã‚¹ã‚³ã‚¢</p>
              <p class="text-3xl font-bold text-blue-600">${training.val_r2.toFixed(3)}</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">RMSE</p>
              <p class="text-3xl font-bold text-purple-600">${training.val_rmse.toFixed(2)}</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow text-center">
              <p class="text-sm text-gray-600 mb-2">å­¦ç¿’ã‚µãƒ³ãƒ—ãƒ«æ•°</p>
              <p class="text-3xl font-bold text-indigo-600">${training.training_samples}</p>
            </div>
          </div>
          
          <!-- æœªæ¥äºˆæ¸¬ -->
          ${future && future.predictions && future.predictions.length > 0 ? `
          <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="font-bold text-xl mb-4 text-gray-800">
              <i class="fas fa-chart-line mr-2"></i>æœªæ¥7æ—¥äºˆæ¸¬
            </h3>
            <canvas id="futurePredictionChart" style="max-height: 400px;"></canvas>
            <div class="grid grid-cols-3 gap-4 mt-4">
              <div class="bg-blue-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">14æ—¥å¾Œäºˆæ¸¬ä¾¡æ ¼</p>
                <p class="text-2xl font-bold text-blue-600">$${future.predictions[future.predictions.length - 1].toFixed(2)}</p>
              </div>
              <div class="bg-green-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">å¤‰åŒ–ç‡</p>
                <p class="text-2xl font-bold text-green-600">
                  ${((future.predictions[future.predictions.length - 1] - future.predictions[0]) / future.predictions[0] * 100).toFixed(2)}%
                </p>
              </div>
              <div class="bg-purple-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">äºˆæ¸¬æœ€é«˜å€¤</p>
                <p class="text-2xl font-bold text-purple-600">$${Math.max(...future.predictions).toFixed(2)}</p>
              </div>
            </div>
          </div>
          ` : ''}
          
          <!-- ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼ -->
          ${backfit ? `
          <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="font-bold text-xl mb-4 text-gray-800">
              <i class="fas fa-chart-area mr-2"></i>ãƒãƒƒã‚¯ãƒ•ã‚£ãƒƒãƒˆæ¤œè¨¼ï¼ˆéå»30æ—¥ï¼‰
            </h3>
            <canvas id="backfitChart" style="max-height: 400px;"></canvas>
            <div class="grid grid-cols-3 gap-4 mt-4">
              <div class="bg-blue-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">RMSEï¼ˆèª¤å·®ï¼‰</p>
                <p class="text-2xl font-bold text-blue-600">${backfit.rmse.toFixed(2)}</p>
              </div>
              <div class="bg-green-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">MAEï¼ˆå¹³å‡èª¤å·®ï¼‰</p>
                <p class="text-2xl font-bold text-green-600">${backfit.mae.toFixed(2)}</p>
              </div>
              <div class="bg-purple-50 p-4 rounded text-center">
                <p class="text-sm text-gray-600 mb-1">æ–¹å‘æ€§æ­£è§£ç‡</p>
                <p class="text-2xl font-bold text-purple-600">${backfit.direction_accuracy.toFixed(1)}%</p>
              </div>
            </div>
          </div>
          ` : ''}
          
          <!-- ç‰¹å¾´é‡é‡è¦åº¦ -->
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-xl mb-4 text-gray-800">
              <i class="fas fa-list-ol mr-2"></i>ç‰¹å¾´é‡é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTop 10ï¼‰
            </h3>
            <canvas id="featureImportanceChart" style="max-height: 350px;"></canvas>
          </div>
        </div>
      `
      
      document.getElementById('system-c-results').innerHTML = html
      
      // ãƒãƒ£ãƒ¼ãƒˆæç”»
      if (future && future.predictions) {
        renderFuturePredictionChart(future, current_price)
      }
      if (backfit) {
        renderBackfitChart(backfit)
      }
      if (featureImportances) {
        renderFeatureImportanceChart(featureImportances)
      }
    }
    
    function renderFuturePredictionChart(future, current_price) {
      const ctx = document.getElementById('futurePredictionChart').getContext('2d')
      
      // ç¾åœ¨ä¾¡æ ¼ã‚’è¿½åŠ ï¼ˆèµ·ç‚¹ã¨ã—ã¦ï¼‰
      const allDates = ['ä»Šæ—¥', ...future.dates]
      const allPredictions = [current_price, ...future.predictions]
      const allUpper = [current_price, ...future.upper_bound]
      const allLower = [current_price, ...future.lower_bound]
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: allDates,
          datasets: [
            {
              label: 'äºˆæ¸¬ä¾¡æ ¼',
              data: allPredictions,
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'transparent',
              borderWidth: 3,
              tension: 0.3,
              fill: false,
              pointRadius: 0
            },
            {
              label: 'ä¿¡é ¼åŒºé–“ï¼ˆä¸Šé™ï¼‰',
              data: allUpper,
              borderColor: 'rgba(156, 163, 175, 0.3)',
              backgroundColor: 'rgba(156, 163, 175, 0.1)',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.3,
              fill: '+1',
              pointRadius: 0
            },
            {
              label: 'ä¿¡é ¼åŒºé–“ï¼ˆä¸‹é™ï¼‰',
              data: allLower,
              borderColor: 'rgba(156, 163, 175, 0.3)',
              backgroundColor: 'rgba(156, 163, 175, 0.1)',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.3,
              fill: false,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: 'ä¾¡æ ¼ (USD)' }
            },
            x: {
              title: { display: true, text: 'æ—¥ä»˜' },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      })
    }
    
    function renderBackfitChart(backfit) {
      const ctx = document.getElementById('backfitChart').getContext('2d')
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: backfit.dates,
          datasets: [
            {
              label: 'å®Ÿéš›ã®ä¾¡æ ¼',
              data: backfit.actual_prices,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.1
            },
            {
              label: 'MLäºˆæ¸¬ä¾¡æ ¼',
              data: backfit.predictions,
              borderColor: 'rgb(249, 115, 22)',
              backgroundColor: 'transparent',
              borderWidth: 2,
              borderDash: [5, 5],
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: 'ä¾¡æ ¼ (USD)' }
            },
            x: {
              title: { display: true, text: 'æ—¥ä»˜' }
            }
          }
        }
      })
    }
    
    function renderFeatureImportanceChart(importances) {
      const ctx = document.getElementById('featureImportanceChart').getContext('2d')
      
      // importancesãŒé…åˆ—ã®å ´åˆï¼ˆ[{feature: 'xxx', importance: 0.123}, ...]ï¼‰
      let features, values
      
      if (Array.isArray(importances)) {
        // Top 10ã®ã¿å–å¾—
        const top10 = importances.slice(0, 10)
        features = top10.map(item => item.feature || item.name || 'Unknown')
        values = top10.map(item => item.importance || item.gain || 0)
      } else if (typeof importances === 'object') {
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆ{feature1: 0.123, feature2: 0.456, ...}ï¼‰
        const entries = Object.entries(importances).slice(0, 10)
        features = entries.map(([key]) => key)
        values = entries.map(([, value]) => value)
      } else {
        console.error('Invalid importances format:', importances)
        return
      }
      
      // è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé‡è¦åº¦ãŒé«˜ã„ã»ã©æ¿ƒã„è‰²ï¼‰
      const maxValue = Math.max(...values)
      const colors = values.map(val => {
        const intensity = val / maxValue
        const r = Math.floor(99 + (34 - 99) * intensity)
        const g = Math.floor(102 + (197 - 102) * intensity)
        const b = Math.floor(241 + (94 - 241) * intensity)
        return `rgba(${r}, ${g}, ${b}, 0.8)`
      })
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: features,
          datasets: [{
            label: 'é‡è¦åº¦ã‚¹ã‚³ã‚¢',
            data: values,
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace('0.8', '1')),
            borderWidth: 2
          }]
        },
        options: {
          indexAxis: 'y',  // æ¨ªæ£’ã‚°ãƒ©ãƒ•
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { 
              display: true,
              text: 'æ ªä¾¡äºˆæ¸¬ã«æœ€ã‚‚å½±éŸ¿ã‚’ä¸ãˆã‚‹10å€‹ã®ç‰¹å¾´é‡',
              font: { size: 14, weight: 'bold' },
              color: '#374151'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.x
                  const total = values.reduce((a, b) => a + b, 0)
                  const percentage = ((value / total) * 100).toFixed(1)
                  return `é‡è¦åº¦: ${value.toFixed(4)} (${percentage}%)`
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: { 
                display: true, 
                text: 'é‡è¦åº¦ã‚¹ã‚³ã‚¢ï¼ˆå€¤ãŒé«˜ã„ã»ã©äºˆæ¸¬ã¸ã®å½±éŸ¿ãŒå¤§ãã„ï¼‰',
                font: { size: 12 },
                color: '#6b7280'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                font: { size: 11 },
                color: '#374151'
              }
            }
          }
        }
      })
    }
  </script>
</body>
</html>
