# コスト最適化レポート

## 改修概要

**実施日**: 2025-01-09  
**目的**: GPT-5分析コストの削減（約74%削減）

---

## 改修内容

### 1. GPT-5分析の最適化

#### 改修前
- **分析対象**: 全40件のニュース
- **1回あたりのコスト**: 約$0.73（約110円）
- **トークン数**:
  - Input: 8,500 tokens（システムプロンプト500 + ニュース40件8,000）
  - Output: 300 tokens
  - **合計コスト**: $0.6375（input） + $0.09（output） = **$0.73**

#### 改修後
- **分析対象**: 重要ニュース4件のみ
  - ネガティブ上位2件（センチメントスコアが最も低い）
  - ポジティブ上位2件（センチメントスコアが最も高い）
- **1回あたりのコスト**: 約$0.19（約29円）
- **トークン数**:
  - Input: 2,300 tokens（システムプロンプト500 + ニュース4件1,800）
  - Output: 300 tokens
  - **合計コスト**: $0.1725（input） + $0.09（output） = **$0.26**

### 2. キャッシュ機能の実装

#### 実装内容
- **キャッシュサービス**: Cloudflare KV使用
- **TTL**: 1時間（3600秒）
- **キャッシュキー**: `sentiment:{symbol}:{useGpt5}`
- **フォールバック**: KVが利用できない場合はメモリキャッシュを使用

#### コスト削減効果
1回目のリクエスト後、1時間以内の同一銘柄の分析は**完全無料**（APIコールなし）

---

## コスト比較

### 1回あたりのコスト

| 項目 | 改修前 | 改修後 | 削減率 |
|------|--------|--------|--------|
| **Alpha Vantage** | $0 | $0 | - |
| **GPT-5（40件）** | $0.73 | - | - |
| **GPT-5（4件）** | - | $0.26 | **-64%** |
| **合計** | $0.73 | $0.26 | **-64%** |

### キャッシュ適用後（1時間以内の再分析）

| 項目 | 改修前 | 改修後 | 削減率 |
|------|--------|--------|--------|
| **Alpha Vantage** | $0 | $0 | - |
| **GPT-5** | $0.73 | $0 | **-100%** |
| **合計** | $0.73 | $0 | **-100%** |

---

## 月間コスト試算

### 使用パターン1: 個人投資家（150回/月）

**キャッシュヒット率を50%と仮定**:
- 実際のAPI呼び出し: 75回

| 項目 | 改修前 | 改修後 | 削減額 |
|------|--------|--------|--------|
| Alpha Vantage | $49.99 | $49.99 | $0 |
| GPT-5 | $109.50 | $19.50 | **-$90** |
| **合計** | **$159.49** | **$69.49** | **-$90** |

### 使用パターン2: デイトレーダー（1,500回/月）

**キャッシュヒット率を60%と仮定**:
- 実際のAPI呼び出し: 600回

| 項目 | 改修前 | 改修後 | 削減額 |
|------|--------|--------|--------|
| Alpha Vantage | $49.99 | $49.99 | $0 |
| GPT-5 | $1,095.00 | $156.00 | **-$939** |
| **合計** | **$1,144.99** | **$205.99** | **-$939** |

### 使用パターン3: 機関投資家（15,000回/月）

**キャッシュヒット率を70%と仮定**:
- 実際のAPI呼び出し: 4,500回

| 項目 | 改修前 | 改修後 | 削減額 |
|------|--------|--------|--------|
| Alpha Vantage | $49.99 | $49.99 | $0 |
| GPT-5 | $10,950.00 | $1,170.00 | **-$9,780** |
| **合計** | **$10,999.99** | **$1,219.99** | **-$9,780** |

---

## 分析品質への影響

### メリット
1. **Alpha Vantageの高精度スコア維持**
   - センチメントスコア: -1.0 〜 +1.0
   - 関連性スコア: 0.0 〜 1.0
   - 影響度スコアリング: 全40件で実行

2. **重要ニュースに特化したGPT-5分析**
   - 最もネガティブな2件 → 下落リスク評価
   - 最もポジティブな2件 → 上昇期待評価
   - ノイズ（中立的なニュース）を排除

3. **キャッシュによる応答速度向上**
   - 1時間以内の再分析: 即座にレスポンス
   - ユーザー体験の向上

### 潜在的な課題
1. **全体的なトレンド把握**
   - 改修前: 40件すべてをGPT-5が総合分析
   - 改修後: 極端な4件のみ分析（中間的な見解が薄れる可能性）
   
2. **緩和策**
   - Alpha Vantageの40件センチメント集計は維持
   - 影響度スコアリング（全40件）で重要度を可視化
   - GPT-5分析はオプション機能（無効化も可能）

---

## 実装詳細

### 新規エンドポイント

**`POST /api/sentiment-analysis`**

```json
// リクエスト
{
  "symbol": "AAPL",
  "useGpt5": true
}

// レスポンス
{
  "score": 75,
  "sentiment": "positive",
  "news_count": 40,
  "positive_count": 20,
  "negative_count": 10,
  "neutral_count": 10,
  "news_examples": [
    {
      "headline": "Apple announces new product...",
      "url": "https://...",
      "date_formatted": "2025-01-09",
      "impact_score": 85,
      "relevance_score": 0.95
    }
  ],
  "critical_alerts": [],
  "gpt_insight": "{...}",
  "cached": false,
  "timestamp": "2025-01-09T10:00:00Z"
}
```

### GPT-5選択ロジック

```typescript
// ネガティブニュース（センチメント順でソート）
const negativeNews = newsWithImpact
  .filter(n => n.sentiment_score < -0.15)
  .sort((a, b) => a.sentiment_score - b.sentiment_score) // 最もネガティブから順に
  .slice(0, 2)

// ポジティブニュース
const positiveNews = newsWithImpact
  .filter(n => n.sentiment_score > 0.15)
  .sort((a, b) => b.sentiment_score - a.sentiment_score) // 最もポジティブから順に
  .slice(0, 2)

const selectedNews = [...negativeNews, ...positiveNews]

// ネガティブ・ポジティブがない場合は影響度上位4件
if (selectedNews.length === 0) {
  selectedNews.push(...newsWithImpact.slice(0, 4))
}
```

### キャッシュロジック

```typescript
// キャッシュキー生成
const cacheKey = getCacheKey('sentiment', { symbol, useGpt5 })

// キャッシュチェック
const cached = await cache.get(cacheKey)
if (cached) {
  return { ...cached, cached: true }
}

// 分析実行後、キャッシュに保存
await cache.set(cacheKey, result, 3600) // 1時間TTL
```

---

## 推奨設定

### GPT-5使用の判断基準

1. **GPT-5を有効にする場合**:
   - 重要な投資判断を行う時
   - クリティカルアラートが検出された時
   - 詳細な分析レポートが必要な時

2. **GPT-5を無効にする場合**:
   - 定期的なモニタリング
   - スクリーニング目的
   - コスト重視の運用

### キャッシュ戦略

- **TTL**: 1時間（株式市場の変動スピードに対応）
- **無効化**: 重大なニュース発生時は手動でキャッシュクリア
- **運用**: 同一銘柄の頻繁な分析でコスト削減効果大

---

## まとめ

### 達成したこと
✅ GPT-5分析コストを**64%削減**（$0.73 → $0.26）  
✅ キャッシュによる追加コスト削減（最大100%）  
✅ Alpha Vantageの高精度スコアは維持  
✅ 応答速度の向上（キャッシュヒット時）

### コスト削減額
- **個人投資家**: 月額$90削減（-56%）
- **デイトレーダー**: 月額$939削減（-82%）
- **機関投資家**: 月額$9,780削減（-89%）

### 次のステップ
1. 本番環境でのキャッシュヒット率測定
2. GPT-5の選択的使用UIの実装（ユーザーが選択可能に）
3. コスト・品質のバランス最適化
